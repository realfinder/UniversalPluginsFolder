<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">

<html>
<head>
	<title>Barrel Function</title>
</head>

<body>
	   <font color="#cc0033"><h1>Barrel </h1></font>
	 
	  <BR><b>Author<a href="../vcmohan.html"> V. C. Mohan</a></b>
	  <BR> Date 1 oct 2020
	  
	  
	  <p>This plugin corrects Barrel type or Pin Cushion type distortions in 
	  an image that result in due to camera lens projecting image on to
	  a flat film or sensor array. ( The
	  distortions due to perspective are not compensated by this plugin. For
	   correcting perspective distortion one need to use
	    Reform function of this plugin.)
		This plugin can also correct for distortions which are different along x and y directions
		
		In the test mode a  distorted matrix of dots is overlain on the specified frame. These will be along lines which will be straightened. Best fit parameters can be arrived at. </p>
	  <P><b>Input formats RGB, Y or YUV444 (no subsampling)only are acceptable.All bit depths are handled. This function is Thread safe. MT_NICE_FILTER</b></P>
	  <P> A polynomial with 4 coefficients are used to correct. <b>a</b>, <b>b</b>,
	   and <b>c</b> are the
	  coefficients to be specified and the fourth <b>d</b> is computed internally.
	  These parameters mainly depend upon the lens of the camera, focal length of lens 
	  and setting of zoom.</p> 
	  
	  <p>For many high definition still photographic cameras  databases are
	  available on the web. But for video cams there is no such database. The possible reasons
	  are 1. Video camera resolution is limited 2. The camera and or subjects move 
	  and therefore such distortions are not noticeable. However, due to advent of HD
	  video cams and the consequent increased usage of tripod one may attempt to 
	  correct for such distortions.</p> 	  
	  
	  <P>By the use of test mode the values of coefficients can be arrived at. For a 
	  particular camera and setting of focus, these coefficients will remain same.
	  In test mode the number of steps, the range of each of the coefficients etc.
	  are specified. Then a clip with the selected frame of input clip as background 
	  is overlain with dots which lie along distorted lines. Each increment
	  of output frame, these coefficients are altered by a step. This display may aid
	  in selecting proper coefficients. </P>
	  
	  <p>On some images  unequal  vertical and horizontal distortions are 
	  noticeable as in cinemascope. A parameter vh can be used. This specifies the ratio of 
	  vertical to horizontal distortion.</p>
	  
	  <BR> Note <b>a + b + c</b> should not exceed <b>1.0 </b>.
	  <BR>Input clip  <b>RGB and Planar</b> formats only . 
	  <BR>After correction one may need to crop image at the edges.
	  
<br><b<u>>Note. This Barrel or Pin cushion distortion correction must be done on
 un cropped image  or on symmetrically cropped image as it assumes the center of distortion to be the center of frame.</u></b>
<table border="2" bordercolorlight="#c0c0c0" bordercolordark="#000000">

<caption align="top">Details of parameters </caption>
<tr>
       <td><b>Description</b></td>
       <td><b>Name</b></td>
       <td><b>Type</b></td>
       <td><b>Limits</b></td>
       <td><b>Default</b></td>
</tr>
<tr>
       <td>Input clip </td>
       <td></td>
       <td>clip</td>
       <td>RGB or planar YUV444 or Y format only</td>
       <td>none</td>
</tr>

<tr>
       <td>coefficient a (xa in independant mode and start val in test mode)</td>
       <td>a</td>
       <td>float</td>
       <td>between  0.0 and 0.5</td>
       <td>0.005</td>
</tr>

<tr>
       <td>coefficient b(xb in independant mode and start val in test mode)</td>
       <td>b</td>
       <td>float</td>
       <td>between  0.0 and 0.5</td>
       <td>0.005</td>
</tr>

<tr>
       <td>coefficient c(xc in independant mode and start val in test mode)</td>
       <td>c</td>
       <td>float</td>
       <td>between 0.0 and 0.5</td>
       <td>0.005</td>
</tr>

<tr>
       <td>whether to correct pin cushion or barrel type distortion</td>
       <td>pin</td>
       <td>Boolean</td>
       <td>true for pin, false for barrel</td>
       <td>false</td>
</tr>

<tr>
       <td>vertical to horizontal distortion ratio</td>
       <td>vh</td>
       <td>float</td>
       <td>between 0.1 and 10</td>
       <td>1.0</td>
</tr>

<tr>
       <td>whether in test mode</td>
       <td>test</td>
       <td>Boolean</td>
       <td>true for test, false for normal</td>
       <td>false</td>
</tr>

<tr>
       <td>end value of coefficient a in test mode(xea in independant mode)</td>
       <td>ea</td>
       <td>float</td>
       <td>between 0 and 0.5</td>
       <td>a</td>
</tr>

<tr>
       <td>end value of coefficient b in test mode(xeb in independant mode)</td>
       <td>eb</td>
       <td>float</td>
       <td>between 0 and 0.5</td>
       <td>b</td>
</tr>

<tr>
       <td>end value of coefficient c in test mode(xec in independant mode)</td>
       <td>ec</td>
       <td>float</td>
       <td>between 0 and 0.5</td>
       <td>c</td>
</tr>

<tr>
       <td>number of steps for variation ( in test mode only)</td>
       <td>nsteps</td>
       <td>integer</td>
       <td>between 0 and 100</td>
       <td>20</td>
</tr>

<tr>
       <td>input frame number for over lay ( in test mode only)</td>
       <td>frame</td>
       <td>Int</td>
       <td>within input clip</td>
       <td>0</td>
</tr>

<tr>
       <td>color of dots in test mode and left out borders in normal</td>
       <td>color</td>
       <td>Int</td>
       <td>in RRGGBB format</td>
       <td>0</td>
	   
</tr>

<tr>
       <td>whether x and y have independant coefficients</td>
       <td>ind</td>
       <td>Boolean</td>
       <td>true for independant, false for pin cushion or barrel</td>
       <td>false</td>
</tr>

<tr>
       <td>whether Y direction has pin cushion distortion?</td>
       <td>ypin</td>
       <td>Boolean</td>
       <td>true for pin cushion, false for  barrel</td>
       <td>false</td>
</tr>

<tr>
       <td> value of coefficient ya ( start value in test mode )</td>
       <td>ya</td>
       <td>float</td>
       <td>between 0 and 0.5</td>
       <td>a</td>
</tr>

<tr>
       <td>value of coefficient yb (start value in test mode)</td>
       <td>yb</td>
       <td>float</td>
       <td>between 0 and 0.5</td>
       <td>b</td>
</tr>

<tr>
       <td>value of coefficient yc (start value in test mode)</td>
       <td>yc</td>
       <td>float</td>
       <td>between 0 and 0.5</td>
       <td>c</td>
</tr>

<tr>
       <td>end value of coefficient ya ( in test mode only)</td>
       <td>yea</td>
       <td>float</td>
       <td>between 0 and 0.5</td>
       <td>ya</td>
</tr>

<tr>
       <td>end value of coefficient yb ( in test mode only)</td>
       <td>yeb</td>
       <td>float</td>
       <td>between 0 and 0.5</td>
       <td>yb</td>
</tr>

<tr>
       <td>end value of coefficient yc ( in test mode only)</td>
       <td>yec</td>
       <td>float</td>
       <td>between 0 and 0.5</td>
       <td>yc</td>
</tr>
<tr>
       <td>dot density( in test mode only)</td>
       <td>dots</td>
       <td>int</td>
       <td>between 1 to 4</td>
       <td>2</td>
</tr>



</table>


<BR>#Usage examples:- 
<pre>
blankclip(width = 720, height = 480, pixel_type = "RGB32",color = $ffffff,  length = 10)
grid()
pin = Barrel(a = 0.005, b = 0.005, c = 0.005,pin = false)
 bar = Barrel(a = 0.005, b = 0.005, c = 0.005,pin = true)
 test for image with independant distortions:-
 Barrel(test=true,pin=false,  ind = true,a= 0.05,b= 0.011,c= 0.001, ea = .02, eb=0.012,ec= 0.001, ya= 0.1, yb= 0.011,yc= 0.001, yea= 0.01, yeb= 0.005, yec = 0.005 , ypin = true, color = $ffffff)
</pre>
Barrel Distortion Example:-
<BR><img src="./Barrel0.jpeg" border="0"> 

<br>
Pin Cushion Distortion Example
<BR><img src="Pin0.jpeg" border="0">
<br>
Pin cushion and Barrel simultaneous. Use ind = true to correct
<br><img src="./pinAndBarrel0.jpeg" border="0">
<br>

with following script dots displayed

<br>Barrel(im,a = 0.005, b = 0.005, c = 0.005,pin = false, test = true, color = $ffffff)


<br><img src="./barreltest0.png" width="648" height="486" border="0">

<br>
<table>

<tr>
       <td><a href="../manyPlus.html">To my index page</a></td>
	   <td>down load<a href="manyPlus.7z">movePlus </a>plugin</td>
       <td><a href="http://www.avisynth.nl">To Avisynth</a> </td>
</tr>
</table>
</body>
</html>

