<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">

<html>
<head>
	<title>F2QSharp function of  FQPlus Plugin</title>
</head>

<body>
	   <font color="#cc0033"><h1>F2QSharp </h1></font>
	 
	  <BR><b>Author<a href="../vcmohan.html"> V. C. Mohan</a></b>
	  <BR> 29 Dec 2016
	  
	  <p>F2QSharp function operates in frequency domain and requires 
	for 32 bit avisynth+ 
	<a href="http://www.avisynth.nl/users/vcmohan/libfftw3f-3.zip"> FFTw3 32 bit dll</a>  or for 64 bit avisynth+ <a href="http://www.avisynth.nl/users/vcmohan/libfftw3f-3_64bit.zip"> FFTw3 64 bit dll</a>, to be in the path.</p> 
	    
	  <p>Given the  estimate of blur present, F2QSharp function tries 
	  to sharpen the image through frequency domain inversion.</p>
	  
	  <p>In case of motion blur the line is assumed to be symmetric about origin, the 
	  end coordinates of blur line x and y specified will be extended to  -x, -y to get full line. In case of out of focus blur
	  the x coordinate is the radius of blur.</p>
	 
	 <P>All 3 color (planes) of RGB formats and   planar YUV444 if opted (set uv as true) are processed. Otherwise only luma (Y)  is processed.</P>
		
	<p>Inverting in frequency domain can lead to instabilities and to counter
	this white noise is added, which while stabilising reduces  effectiveness and so need to experiment and compromised.
	The radius of designed inversion filter in spatial domain can be specified. This 
	can provide some desirable reduction of ringing. These two operators have
	effect on processed amplitude of the image. Therefore it is essential to
	experiment exhaustively to arrive at optimum scaling parameter for any particular
	situation.</p>
	
	<p>For some situations for a particular set of parameters the result may be highly
	focussing in parts and in other parts amplitudes may be zero. One such condition
	is given in the examples. One must be careful about such situations.</p> 
	
	<BR>Sharpening larger blur can produce noticeable ringing  especially at edges of image.
	Cropping result may be a solution.
<br> As the exact blurring PSF was known in the examples, the results look good. In real life blurring PSF is not known and so inversion likely to fail.	
	<p> The text file to read for user input psf must conform strictly to following :
	<br> 1.Must have number 1 in first line.
	<br>2. Second line first integer is number of values present in each row. The second value on this line is number of rows. A maximum of  16 X 16 rows and columns can only be specified, <br>Third line onwards PSF values in rows and columns. The values are separated by space. Entries are in floating point.</p> 	 
		
<br> F2QSharp is thread safe. SetFilterMTMode("F2QSharp", MT_NICE_FILTER).
<BR><BR>

<table border="2" bordercolorlight="#c0c0c0" bordercolordark="#000000">

<caption align="top">Details of parameters </caption>
<tr>
       <td><b>Description</b></td>
       <td><b>Name</b></td>
       <td><b>Type</b></td>
       <td><b>Limits</b></td>
       <td><b>Default</b></td>
</tr>
<tr>
       <td>Input clip </td>
       <td></td>
       <td>clip</td>
       <td>must have the fields separated</td>
       <td>none</td>
</tr>

<tr>
       <td>Whether blur is linear as in motion blur or out of focus type or PSF given in a text file</td>
       <td>psf</td>
       <td>string</td>
       <td>"line" for linear, "focus" for out of focus or "file"</td>
       <td>"line"</td>
</tr>

<tr>
       <td>white noise to add</td>
       <td>wn</td>
       <td>float</td>
       <td>0.0001 to 0.99</td>
       <td>0.05</td>
</tr>


<tr>
       <td>blur line right end x coordinate or radius of focus blur. Line assumed symmetric about origin</td>
       <td>x</td>
       <td>integer</td>
       <td>2 to 1/8 frame width</td>
       <td>6</td>
</tr>

<tr>
       <td>blur line right end y coordinate.  Line assumed symmetric about origin</td>
       <td>y</td>
       <td>integer</td>
       <td>- 1/8th to 1/8th frame height</td>
       <td>2</td>
</tr>
<tr>
       <td> scaling to be applied post processing</td>
       <td>scale</td>    
   	   <td>float</td>
       <td>0.01 to  1000000</td>
       <td>1.0</td>
</tr>

<tr>
       <td> Radius of filter in spatial domain, as %age of smaller of the frame dimensions</td>
       <td>fr</td>    
   	   <td>float</td>
       <td>0.01 to  39.99</td>
       <td>10</td>
</tr>

<tr>
       <td>scaling of output</td>
       <td>scale</td>
       <td>float</td>
       <td>0.000001 to 10000000</td>
       <td>0.45</td>
</tr>
<tr>
       <td>Full path and name of text file in which  PSF is given.</td> 
       <td>txt</td>
       <td>string</td>
       <td>a valid file name must be specified for psf = "file" option</td>
       <td>none</td>
</tr>


</table>


<BR>#Usage examples. These also demonstrate the artifacts produced and need to select proper scale value:- 
<pre>

f2Qs = F2QSharp(F2Qb,psf = "file", x = 6, y = 2, uv = true,wn = 0.05,scale = 0.4, fr = 20, txt = "C:\avi_plugins\FQPlus\blurr.txt")
### <b>effect of amount of motion blur</b>
## using F2QBLUR as input
F2QSharp()
F2QSharp(line = true,x = 2, y = 2fr = 20,wn = 0.05,scale = 0.45)
F2QSharp(line = true,x = 8, y = 4,fr = 30,wn = 0.05,scale = 0.375)

</pre><br><b>effect of amount of motion blur</b>
<BR> below are results. Left is blurred image.  Right restored image 
<BR><img src="F2QSharp0.jpeg" border="0">
<BR>
<pre>###<b>effect of filter radius</b>
F2QBlur( line = false, x=8,y = 0)
F2QSharp(line = false,x = 8, y = 0,fr = 20,wn = 0.08,scale = 0.45)
F2QSharp(line = false,x = 8, y = 0,fr = 39,wn = 0.08,scale = 0.45)
F2QSharp(fqb8,line = false,x = 8, y = 0,fr = 60,wn = 0.08,scale = 0.45)
FR8 = F2QSharp(fqb8,line = false,x = 8, y = 0,fr = 80,wn = 0.08,scale = 0.45)
st1 = stackvertical(last, fr2,fr4)
st2 = stackvertical(fqb8, fr6,fr8)
stackhorizontal(st1,st2)</pre>

<br><b>effect of filter radius</b>
<BR> below are results. top Left is original. top Right blurred image used as input for all.
note amplitude variation. 
<BR><img src="F2QSharp_Radius0.jpeg" border="0">
<br>
<pre># <b>Degree of defocus of input</b>
fqb2 = F2QBlur( line = false, x=2,y = 0)
fqb4 = F2QBlur( line = false, x=4,y = 0)
fqb8 = F2QBlur( line = false, x=8,y = 0)
fqb16 = F2QBlur( line = false, x=16,y = 0)

FR2 = F2QSharp(fqb2,line = false,x = 2, y = 0,fr = 20,wn = 0.08,scale = 0.45)
FR4 = F2QSharp(fqb4,line = false,x = 4, y = 0,fr = 20,wn = 0.08,scale = 0.45)
FR8 = F2QSharp(fqb8,line = false,x = 8, y = 0,fr = 20,wn = 0.08,scale = 0.45)
FR16 = F2QSharp(fqb16,line = false,x = 16, y = 0,fr = 20,wn = 0.08,scale = 0.45)

st1 = stackvertical(fqb2,fqb4,fqb8, fqb16)
st2 = stackvertical(fr2, fr4,fr8, fr16)
stackhorizontal(st1,st2)</pre>

<br><b>Degree of defocus of input</b>
<br>Left input Right restored image. scale was kept constant 

<br><img src="F2QSharp_Focus0.jpeg" border="0">

<pre>### <b>effect of white noise value wn</b>
 wn</b>
<br>Top left Original, Top right blurred input, scale kept constant
<br><img src="F2QSharp_wn0.jpeg" border="0">


<br>### example of an <b>unstable(?) situation</b>

<br><b>unstable(?) situation</b>. Top large focus blurred input.Lower 3 processed
with very small difference in parameter fr (Filter radius). Note to control amplitude
scale value needed was highest for the central one.

<br><img src="F2QSharp_unstable0.jpeg" border="0"> 
<pre>
Example text file:
1
6 6
0 0 0 0 0.15 1.0
0 0 0 0.15 1.0 0.15
0 0 0.15 1.0 0.15 0
0 0.15 1.0 0.15 0 0
0.15 1.0 0.15 0 0 0
1.0 0.15 0 0 0 0 </pre>

<table>

<tr>
       <td><a href="../index.html">To my index page</a></td>
	   <td><a href="F2QPlus.7z">down load plugin</a></td>
       <td><a href="http://www.avisynth.nl">To Avisynth</a> </td>
</tr>
</table>	
</body>
</html>
